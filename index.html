<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pizza Life: A Day in the Life of a Pizza Maker</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fffbe7; margin: 0; padding: 0; }
    #game-container { max-width: 500px; margin: auto; padding: 2em; background: #fff3c1; border-radius: 10px; margin-top: 3em; box-shadow: 0 4px 12px #0002; }
    #output { min-height: 180px; white-space: pre-wrap; margin-bottom: 1em; }
    #pizza-image { display: block; margin: 1em auto; }
    button { margin: 0.3em 0.5em 0.3em 0; padding: 0.5em 1.5em; border-radius: 5px; border: none; background: #ff9e3d; color: #fff; font-size: 1em; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #status { background: #ffe4a4; border-radius: 8px; padding: 0.7em; margin-bottom: 1em; }
    h1 { text-align: center; color: #d06300; }
    #customise { margin-bottom: 1em; }
    #customise label { margin-right: 1em; }
    #shop { margin-bottom: 1em; }
    #shop h3 { margin-bottom: 0.2em; }
    #shop ul { padding-left: 1.2em; }
    #shop li { margin-bottom: 0.2em; }
    #shop .owned { color: #33a333; }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>üçï Pizza Life üçï</h1>
    <div id="status"></div>
    <div id="output"></div>
    <div id="shop"></div>
    <div id="customise"></div>
    <div id="controls"></div>
  </div>
  
<script>
    // Upgrades available in the shop
    const UPGRADES = [
      {
        id: "oven",
        name: "Better Oven",
        cost: 120,
        desc: "Reduces chance of burning pizza to 5%",
        effect: (state) => { state.burnChance = 0.05; }
      },
      {
        id: "shoes",
        name: "Comfy Shoes",
        cost: 80,
        desc: "Reduces energy lost on delivery by 5",
        effect: (state) => { state.deliveryEnergyCost = 5; }
      },
      {
        id: "box",
        name: "Fancy Box",
        cost: 100,
        desc: "Earn +$10 for each delivery",
        effect: (state) => { state.boxBonus = 10; }
      }
    ];

    // Game state
    let pizzaMan = {
      name: '',
      money: 150,
      energy: 100,
      ordersCompleted: 0,
      hour: 9, // 9 AM
      dayOver: false,
      promotion: false,
      customToppings: [],
      customSauce: 'Tomato',
      upgrades: [],
      // upgrade effects (default values)
      burnChance: 0.15, // default 15% burn
      deliveryEnergyCost: 10, // default 10
      boxBonus: 0,
      // Special endings flags
      mayorDelivered: false,
      spilledSauce: false
    };

    const TOPPINGS = [
      { name: "Pepperoni", bonus: 5 },
      { name: "Mushrooms", bonus: 3 },
      { name: "Onions", bonus: 2 },
      { name: "Pineapple", bonus: 10 },
      { name: "Olives", bonus: 4 }
    ];
    const SAUCES = [
      { name: "Tomato", bonus: 0 },
      { name: "BBQ", bonus: 7 },
      { name: "White Sauce", bonus: 4 }
    ];

    function showStatus() {
      document.getElementById('status').textContent =
        `Money: $${pizzaMan.money}   |   Energy: ${pizzaMan.energy}/100   |   Orders: ${pizzaMan.ordersCompleted}   |   Time: ${pizzaMan.hour}:00` +
        (pizzaMan.promotion ? "   |   üèÖ Promoted!" : "");
    }

    function showOutput(text, opts = {}) {
      const outputDiv = document.getElementById('output');
      outputDiv.innerHTML = ""; // Clear previous output
      // If opts.imgSrc is provided, show the image first
      if (opts.imgSrc) {
        const img = document.createElement('img');
        img.id = 'pizza-image';
        img.src = opts.imgSrc;
        img.alt = "Pizza";
        img.width = 128;
        img.height = 128;
        outputDiv.appendChild(img);
      }
      // Add text below the image, if any
      const txt = document.createElement('div');
      txt.textContent = text;
      outputDiv.appendChild(txt);
    }

    function setControls(buttons) {
      const controlsDiv = document.getElementById('controls');
      controlsDiv.innerHTML = '';
      buttons.forEach(btn => {
        const button = document.createElement('button');
        button.textContent = btn.text;
        button.onclick = btn.action;
        if (btn.disabled) button.disabled = true;
        controlsDiv.appendChild(button);
      });
    }

    function setCustomiseControls(disabled) {
      const customiseDiv = document.getElementById('customise');
      customiseDiv.innerHTML = '';
      const form = document.createElement('form');

      // Sauce selection
      const sauceLabel = document.createElement('label');
      sauceLabel.textContent = 'Sauce:';
      form.appendChild(sauceLabel);

      SAUCES.forEach(sauce => {
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'sauce';
        radio.value = sauce.name;
        if (pizzaMan.customSauce === sauce.name) radio.checked = true;
        radio.disabled = !!disabled;
        radio.onchange = () => {
          pizzaMan.customSauce = sauce.name;
        };
        form.appendChild(radio);
        const lbl = document.createElement('span');
        lbl.textContent = sauce.name;
        form.appendChild(lbl);
      });

      // Toppings selection
      const toppingsLabel = document.createElement('label');
      toppingsLabel.textContent = 'Toppings:';
      toppingsLabel.style.marginLeft = '1em';
      form.appendChild(toppingsLabel);

      TOPPINGS.forEach(topping => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = topping.name;
        checkbox.checked = pizzaMan.customToppings.includes(topping.name);
        checkbox.disabled = !!disabled;
        checkbox.onchange = () => {
          if (checkbox.checked) {
            pizzaMan.customToppings.push(topping.name);
          } else {
            pizzaMan.customToppings = pizzaMan.customToppings.filter(t => t !== topping.name);
          }
        };
        form.appendChild(checkbox);
        const lbl = document.createElement('span');
        lbl.textContent = topping.name;
        form.appendChild(lbl);
      });

      customiseDiv.appendChild(form);
    }

    function setShopControls(backToGameCallback) {
      const shopDiv = document.getElementById('shop');
      shopDiv.innerHTML = `<h3>üõí Shop Upgrades</h3><ul></ul>`;
      const list = shopDiv.querySelector('ul');
      UPGRADES.forEach(upg => {
        const li = document.createElement('li');
        const owned = pizzaMan.upgrades.includes(upg.id);
        li.innerHTML = `<b>${upg.name}</b> - $${upg.cost} &mdash; ${upg.desc}
          ${owned ? '<span class="owned">[Owned]</span>' : ''}
        `;
        if (!owned) {
          const btn = document.createElement('button');
          btn.textContent = "Buy";
          btn.disabled = pizzaMan.money < upg.cost;
          btn.onclick = () => {
            pizzaMan.money -= upg.cost;
            pizzaMan.upgrades.push(upg.id);
            // Activate upgrade effect
            upg.effect(pizzaMan);
            showOutput(`You bought the ${upg.name}!`);
            setShopControls(backToGameCallback);
            showStatus();
            setCustomiseControls(false);
            setControls([
              { text: "Back to Game", action: backToGameCallback }
            ]);
          };
          li.appendChild(btn);
        }
        list.appendChild(li);
      });
      // Add Back to Game button
      setControls([
        { text: "Back to Game", action: backToGameCallback }
      ]);
    }

    function resetGame() {
      pizzaMan = {
        name: '',
        money: 150,
        energy: 100,
        ordersCompleted: 0,
        hour: 9,
        dayOver: false,
        promotion: false,
        customToppings: [],
        customSauce: 'Tomato',
        upgrades: [],
        burnChance: 0.15, // default 15% burn
        deliveryEnergyCost: 10, // default 10
        boxBonus: 0,
        mayorDelivered: false,
        spilledSauce: false
      };
      askNameScreen();
    }

    function askNameScreen() {
      showStatus();
      showOutput("Welcome to Pizza Life: A Day in the Life of a pizza maker!\nWhat's your name, Pizza Man?");
      document.getElementById('customise').innerHTML = '';
      document.getElementById('shop').innerHTML = '';
      const controlsDiv = document.getElementById('controls');
      controlsDiv.innerHTML = '<input type="text" id="nameInput" placeholder="Your name" style="font-size:1em;"> <button id="startBtn">Start</button>';
      document.getElementById('startBtn').onclick = () => {
        const val = document.getElementById('nameInput').value.trim();
        if (val.length > 0) {
          pizzaMan.name = val;
          gameLoop();
        }
      };
    }

    function gameLoop() {
      // Special ending check
      if (pizzaMan.dayOver) {
        specialEnding();
        return;
      }
      if (pizzaMan.hour > 22) {
        dayEnd();
        return;
      }
      showStatus();

      let promoBtn = {
        text: pizzaMan.promotion ? "Promotion Purchased" : "Buy Promotion ($100)",
        action: () => {},
        disabled: pizzaMan.promotion || pizzaMan.money < 100
      };
      if (!pizzaMan.promotion && pizzaMan.money >= 100) {
        promoBtn.action = () => {
          pizzaMan.money -= 100;
          pizzaMan.promotion = true;
          showOutput("Congratulations! You got a promotion. You will now earn extra money for every delivery!");
          document.getElementById('shop').innerHTML = '';
          setCustomiseControls(true);
          setControls([
            { text: "Continue", action: () => { gameLoop(); } }
          ]);
        };
      }

      setCustomiseControls(false);
      document.getElementById('shop').innerHTML = '';

      if (pizzaMan.energy < 35) {
        showOutput("You look tired. Maybe take a break?");
        setControls([
          { text: "Rest", action: () => { rest(); } },
          { text: "End Day", action: () => { dayEnd(); } },
          { text: "Go to Shop", action: () => { setShopControls(gameLoop); } },
          promoBtn
        ]);
        return;
      }

      showOutput(`It is now ${pizzaMan.hour}:00.\nA customer wants to order a pizza.\nCustomise your pizza below for possible bonuses!\nYou can visit the Shop at any time.`);
      setControls([
        { text: "Accept Order", action: () => { takeOrder(); } },
        { text: "Decline Order", action: () => { declineOrder(); } },
        { text: "Rest", action: () => { rest(); } },
        { text: "End Day", action: () => { dayEnd(); } },
        { text: "Go to Shop", action: () => { setShopControls(gameLoop); } },
        promoBtn
      ]);
    }

    function takeOrder() {
      showStatus();
      showOutput("Order accepted!\nNow, make the pizza.");
      setCustomiseControls(true);
      document.getElementById('shop').innerHTML = '';
      setControls([
        { text: "Make Pizza", action: () => { makePizza(); } },
        { text: "Rest", action: () => { rest(); } },
        { text: "Go to Shop", action: () => { setShopControls(takeOrder); } }
      ]);
    }

    function calculateBonus() {
      let bonus = 0;
      // Sauce bonus
      let sauceObj = SAUCES.find(s => s.name === pizzaMan.customSauce);
      if (sauceObj) bonus += sauceObj.bonus;

      // Topping bonuses (sum, max 3 toppings for bonus)
      let toppingCount = 0;
      pizzaMan.customToppings.forEach(tn => {
        if (toppingCount < 3) {
          let top = TOPPINGS.find(t => t.name === tn);
          if (top) {
            bonus += top.bonus;
            toppingCount++;
          }
        }
      });
      return bonus;
    }

    // Special scenario: 2% chance for mayor delivery, 2% for sauce spill (once per play)
    function checkSpecialDelivery() {
      if (!pizzaMan.mayorDelivered && Math.random() < 0.02) {
        pizzaMan.mayorDelivered = true;
        pizzaMan.dayOver = true;
        return "mayor";
      }
      if (!pizzaMan.spilledSauce && Math.random() < 0.02) {
        pizzaMan.spilledSauce = true;
        pizzaMan.dayOver = true;
        return "sauce";
      }
      return null;
    }

    function makePizza() {
      showStatus();
      let success = Math.random() >= pizzaMan.burnChance;
      pizzaMan.energy -= 5;
      if (success) {
        // Show pizza image on successful pizza!
        let bonus = calculateBonus();
        let bonusMsg = "";
        if (bonus > 0) bonusMsg = `\nPizza Customisation Bonus! +$${bonus}`;
        showOutput(
          "Pizza made successfully!\nTime to deliver it!" + bonusMsg,
          { imgSrc: "image1" }
        );
        document.getElementById('shop').innerHTML = '';
        setControls([
          { text: "Deliver Pizza", action: () => { deliverPizza(bonus); } },
          { text: "Go to Shop", action: () => { setShopControls(makePizza); } }
        ]);
      } else {
        // Firing logic: 0.01% chance (1 in 10,000)
        if (Math.random() <= 0.0001) {
          showOutput("Oh no! You burned the pizza... and your boss FIRED you on the spot!\nThe workday ends abruptly.");
          document.getElementById('shop').innerHTML = '';
          setCustomiseControls(true);
          setControls([
            { text: "Play Again", action: () => { resetGame(); } }
          ]);
          pizzaMan.dayOver = true;
        } else {
          pizzaMan.money -= 150;
          showOutput("Oh no! You burned the pizza. You still gave the pizza. The customer got sick. PAY THE HOSPITAL BILLS!");
          pizzaMan.hour++;
          document.getElementById('shop').innerHTML = '';
          setCustomiseControls(true);
          setControls([
            { text: "Next Hour", action: () => { gameLoop(); } },
            { text: "Go to Shop", action: () => { setShopControls(gameLoop); } }
          ]);
        }
      }
    }

    function deliverPizza(customBonus = 0) {
      // Check for special endings first!
      let special = checkSpecialDelivery();
      if(special === "mayor") {
        specialEnding(); return;
      } else if(special === "sauce") {
        specialEnding(); return;
      }

      showStatus();
      let tip = Math.floor(Math.random() * 20) + 3;
      let baseEarnings = 15 + tip;
      let promoBonus = pizzaMan.promotion ? 15 : 0;
      let fancyBoxBonus = pizzaMan.boxBonus;
      pizzaMan.money += baseEarnings + promoBonus + customBonus + fancyBoxBonus;
      pizzaMan.energy -= pizzaMan.deliveryEnergyCost;
      pizzaMan.ordersCompleted += 1;
      pizzaMan.hour++;

      let rushEvent = "";
      if (Math.random() < 0.4) {
        rushEvent = "\nUnexpected rush! You get an extra order but lose more energy.";
        pizzaMan.energy -= pizzaMan.deliveryEnergyCost;
      }

      let promoMsg = pizzaMan.promotion ? `\nPromotion Bonus! +$${promoBonus}` : "";
      let customMsg = customBonus > 0 ? `\nCustom Pizza Bonus! +$${customBonus}` : "";
      let boxMsg = fancyBoxBonus > 0 ? `\nFancy Box Bonus! +$${fancyBoxBonus}` : "";
      showOutput(`Pizza delivered! You earned $15 and got a tip of $${tip}.${promoMsg}${boxMsg}${customMsg}${rushEvent}`);
      document.getElementById('shop').innerHTML = '';
      setCustomiseControls(false);
      setControls([
        { text: "Next Hour", action: () => { gameLoop(); } },
        { text: "Go to Shop", action: () => { setShopControls(gameLoop); } }
      ]);
    }

    // Show special endings if triggered in gameLoop or after delivery
    function specialEnding() {
      let text = "";
      if (pizzaMan.mayorDelivered) {
        text = `SPECIAL ENDING: Mayor Delivery!\n\nYou delivered pizza to the mayor! The mayor loved your pizza so much that you were awarded the key to the city and free pizza for life. Congratulations, ${pizzaMan.name}!\n\nGAME OVER`;
      } else if (pizzaMan.spilledSauce) {
        text = `SPECIAL ENDING: Sauce Catastrophe!\n\nOh no! You tripped and spilled sauce everywhere, causing chaos in the pizzeria. The whole store had to close for a deep clean. Better luck (and balance) next time, ${pizzaMan.name}!\n\nGAME OVER`;
      }
      showStatus();
      showOutput(text);
      document.getElementById('shop').innerHTML = '';
      setCustomiseControls(true);
      setControls([
        { text: "Play Again", action: () => { resetGame(); } }
      ]);
    }

    function rest() {
      showStatus();
      pizzaMan.energy = Math.min(100, pizzaMan.energy + 60);
      pizzaMan.hour++;
      showOutput("You take a break and feel refreshed!");
      document.getElementById('shop').innerHTML = '';
      setCustomiseControls(false);
      setControls([
        { text: "Next Hour", action: () => { gameLoop(); } },
        { text: "Go to Shop", action: () => { setShopControls(gameLoop); } }
      ]);
    }

    function declineOrder() {
      pizzaMan.energy -= 0;
      pizzaMan.money += 10;
      pizzaMan.hour++;
      showOutput("Order declined. The customer is happy you did not make her fat. She gives you $10.");
      document.getElementById('shop').innerHTML = '';
      setCustomiseControls(false);
      setControls([
        { text: "Next Hour", action: () => { gameLoop(); } },
        { text: "Go to Shop", action: () => { setShopControls(gameLoop); } }
      ]);
    }

    function dayEnd() {
      pizzaMan.dayOver = true;
      showStatus();
      showOutput(`The workday is over!\n\n${pizzaMan.name}'s results:\nMoney: $${pizzaMan.money}\nEnergy: ${pizzaMan.energy}/100\nOrders completed: ${pizzaMan.ordersCompleted}\n\nThanks for playing!`);
      document.getElementById('shop').innerHTML = '';
      setCustomiseControls(true);
      setControls([
        { text: "Play Again", action: () => { resetGame(); } }
      ]);
    }
    
    // Start game on load
    askNameScreen();
  </script>
</body>
</html>
